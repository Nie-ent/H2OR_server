datasource db {
  provider = "mysql"
}

generator client {
  provider        = "prisma-client-js"
  output          = "../generated/prisma"
  previewFeatures = ["clientExtensions"]
}

// ----------------------------------------------------
// ENUMS
// ----------------------------------------------------

enum Role {
  admin
  super_admin
}

enum Difficulty {
  easy
  medium
  hard
}

enum StatusEnum {
  pending
  accepted
  rejected
}

enum CandidateStatusEnum {
  pending // รอการพิจารณา
  pass // ผ่านขั้นตอน
  fail // ไม่ผ่านขั้นตอน
}

enum DocTypeEnum {
  pdf
  png
  jpg
}

enum AddressType {
  primary
  mailing
  permanent
}

// ----------------------------------------------------
// USER & ADMIN MODELS
// ----------------------------------------------------

model AdminUser {
  admin_user_id Int      @id @default(autoincrement())
  first_name    String
  last_name     String
  email         String   @unique
  role          Role
  password_hash String
  created_at    DateTime @default(now())

  // Relationship
  approved_status_updates StatusUpdateRequests[] @relation("ApprovedByAdmin")
}

model Candidate {
  candidate_id      Int     @id @default(autoincrement())
  first_name        String
  last_name         String
  email             String  @unique
  phone             String?
  gender            String?
  age               Int?
  experience_salary Int?
  expected_salary   Int?
  stack             String?
  id_card           String?
  // *** Field 'address' ถูกลบออกแล้ว ***

  // Relationships
  tests              Test[]
  candidate_statuses CandidateStatus[]
  documents          Document[]
  addresses          Address[] // 1:N Relationship: ผู้สมัคร 1 คน มีที่อยู่ได้หลายรายการ
}

// ----------------------------------------------------
// NEW ADDRESS MODEL
// ----------------------------------------------------

model Address {
  address_id    Int         @id @default(autoincrement())
  candidate_id  Int // FK
  address_line1 String
  address_line2 String?
  city          String
  state         String?
  postal_code   String
  country       String
  address_type  AddressType // เช่น Primary, Mailing, Permanent
  is_current    Boolean     @default(true) // เป็นที่อยู่ปัจจุบันหรือไม่

  // Relationship
  candidate Candidate @relation(fields: [candidate_id], references: [candidate_id])

  @@unique([candidate_id, address_type]) // ข้อเสนอแนะ: แต่ละประเภทที่อยู่มีได้เพียงรายการเดียวต่อผู้สมัคร
}

// ----------------------------------------------------
// CANDIDATE STATUS & DOCUMENTS
// ----------------------------------------------------

model CandidateStatus {
  candidate_status_id Int                 @id @default(autoincrement())
  candidate_id        Int
  status              CandidateStatusEnum
  updated_by          Int?
  created_at          DateTime            @default(now())
  updated_at          DateTime            @updatedAt

  // Relationships
  candidate              Candidate              @relation(fields: [candidate_id], references: [candidate_id])
  status_update_requests StatusUpdateRequests[]
}

model StatusUpdateRequests {
  status_update_request_id Int        @id @default(autoincrement())
  candidate_status_id      Int
  requested_status         StatusEnum
  request_by               Int?
  approve_by               Int?
  status                   StatusEnum @default(pending)
  created_at               DateTime   @default(now())
  approved_at              DateTime?

  // Relationships
  candidate_status CandidateStatus @relation(fields: [candidate_status_id], references: [candidate_status_id])
  approver         AdminUser?      @relation("ApprovedByAdmin", fields: [approve_by], references: [admin_user_id])
}

model Document {
  document_id  Int         @id @default(autoincrement())
  candidate_id Int
  file_url     String
  file_type    String
  doc_type     DocTypeEnum
  uploaded_at  DateTime    @default(now())

  // Relationships
  candidate Candidate @relation(fields: [candidate_id], references: [candidate_id])

  @@unique([candidate_id, doc_type])
}

// ----------------------------------------------------
// TESTING MODELS (ไม่เปลี่ยนแปลงจากเดิม)
// ----------------------------------------------------

model Question {
  question_id   Int        @id @default(autoincrement())
  question_text String
  mcq           Boolean    @default(true)
  difficulty    Difficulty
  created_at    DateTime   @default(now())

  // Relationships
  choices        Choice[]
  test_questions TestQuestion[]
  testAnswers    TestAnswer[]
}

model Choice {
  choice_id   Int     @id @default(autoincrement())
  question_id Int
  choice_text String
  is_correct  Boolean @default(false)

  // Relationships
  question         Question     @relation(fields: [question_id], references: [question_id])
  selected_answers TestAnswer[] @relation("SelectedChoice")

  @@unique([question_id, choice_text])
}

model Test {
  test_id      Int       @id @default(autoincrement())
  candidate_id Int
  total_score  Int?
  created_at   DateTime  @default(now())
  completed_at DateTime?

  // Relationships
  candidate      Candidate      @relation(fields: [candidate_id], references: [candidate_id])
  test_questions TestQuestion[]
  test_answers   TestAnswer[]
}

model TestQuestion {
  test_question_id Int @id @default(autoincrement())
  test_id          Int
  question_id      Int

  // Relationships
  test     Test     @relation(fields: [test_id], references: [test_id])
  question Question @relation(fields: [question_id], references: [question_id])

  @@unique([test_id, question_id])
}

model TestAnswer {
  test_answer_id     Int      @id @default(autoincrement())
  test_id            Int
  question_id        Int
  selected_choice_id Int?
  is_correct         Boolean?

  // Relationships
  test            Test     @relation(fields: [test_id], references: [test_id])
  question        Question @relation(fields: [question_id], references: [question_id])
  selected_choice Choice?  @relation("SelectedChoice", fields: [selected_choice_id], references: [choice_id])

  @@unique([test_id, question_id])
}
